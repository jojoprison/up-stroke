<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UpStroke UI</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    h1 { margin: 0 0 12px; font-size: 20px; }
    .row { display: flex; gap: 8px; align-items: center; margin-bottom: 12px; }
    input { padding: 8px; min-width: 260px; }
    button { padding: 8px 12px; cursor: pointer; }
    pre { background: rgba(127,127,127,.15); padding: 12px; border-radius: 8px; overflow: auto; }
    a { color: #0b84ff; text-decoration: none; }
    .toolbar { display: flex; gap: 8px; align-items: center; margin-bottom: 12px; flex-wrap: wrap; }
    .btn { padding: 8px 12px; cursor: pointer; }
    .cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; margin-top: 12px; }
    .card { border: 1px solid rgba(127,127,127,.3); border-radius: 8px; padding: 12px; background: rgba(127,127,127,.08); }
    .kv { display: grid; grid-template-columns: auto 1fr; gap: 6px 12px; }
    .k { font-weight: 600; }
    .v { word-break: break-word; }
  </style>
</head>
<body>
  <h1>UpStroke UI</h1>
  <div class="row toolbar">
    <input id="endpoint" value="/" />
    <button id="rootBtn" class="btn">GET /</button>
    <button id="send" class="btn">Запросить</button>
    <button id="refresh" class="btn">Повторить</button>
    <button id="toggleView" class="btn" data-mode="json">Вид: Карточки</button>
    <button id="copy" class="btn">Копировать</button>
    <a href="/docs" target="_blank" rel="noreferrer">Swagger</a>
  </div>
  <div id="cards" class="cards" hidden></div>
  <pre id="out">Здесь будет ответ API...</pre>

  <script>
    const out = document.getElementById('out');
    const cards = document.getElementById('cards');
    const endpoint = document.getElementById('endpoint');
    const sendBtn = document.getElementById('send');
    const rootBtn = document.getElementById('rootBtn');
    const refreshBtn = document.getElementById('refresh');
    const toggleBtn = document.getElementById('toggleView');
    const copyBtn = document.getElementById('copy');

    let lastPath = '/';
    let lastData = null; // parsed JSON or null
    let mode = 'json'; // 'json' or 'cards'

    function renderJSON(data) {
      out.textContent = JSON.stringify(data, null, 2);
      out.hidden = false;
      cards.hidden = true;
    }

    function renderCards(data) {
      if (data && typeof data === 'object' && !Array.isArray(data)) {
        const html = Object.entries(data).map(([k, v]) => {
          const val = typeof v === 'object' ? JSON.stringify(v) : String(v);
          return `<div class="card"><div class="kv"><div class="k">${escapeHtml(k)}</div><div class="v">${escapeHtml(val)}</div></div></div>`;
        }).join('');
        cards.innerHTML = html || '<div>Пусто</div>';
        cards.hidden = false;
        out.hidden = true;
      } else {
        // если это массив или примитив — показываем JSON
        renderJSON(data);
      }
    }

    function escapeHtml(s) {
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    async function callApi(path) {
      lastPath = path;
      out.hidden = false;
      cards.hidden = true;
      out.textContent = 'Загрузка...';
      try {
        const res = await fetch(path, { headers: { 'Accept': 'application/json' } });
        const text = await res.text();
        try {
          const json = JSON.parse(text);
          lastData = json;
          if (mode === 'json') renderJSON(json);
          else renderCards(json);
        } catch {
          lastData = null;
          out.textContent = text;
          out.hidden = false;
          cards.hidden = true;
        }
      } catch (e) {
        lastData = null;
        out.textContent = 'Ошибка: ' + (e?.message || e);
      }
    }

    function toggleView() {
      if (!lastData) return; // переключение только когда есть JSON
      mode = mode === 'json' ? 'cards' : 'json';
      toggleBtn.textContent = mode === 'json' ? 'Вид: Карточки' : 'Вид: JSON';
      if (mode === 'json') renderJSON(lastData);
      else renderCards(lastData);
    }

    async function copyCurrent() {
      const text = lastData ? JSON.stringify(lastData, null, 2) : out.textContent;
      try {
        await navigator.clipboard.writeText(text);
        copyBtn.textContent = 'Скопировано!';
        setTimeout(() => (copyBtn.textContent = 'Копировать'), 1200);
      } catch {}
    }

    sendBtn.addEventListener('click', () => callApi(endpoint.value.trim() || '/'));
    rootBtn.addEventListener('click', () => { endpoint.value = '/'; callApi('/'); });
    refreshBtn.addEventListener('click', () => callApi(endpoint.value.trim() || lastPath || '/'));
    toggleBtn.addEventListener('click', toggleView);
    copyBtn.addEventListener('click', copyCurrent);

    // Авто-запрос на корень при загрузке
    callApi('/');
  </script>
</body>
</html>
